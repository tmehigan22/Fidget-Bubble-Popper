<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Pop It</title>
  <style>
    :root{
      --bg: #00A6FB;                 /* UPDATED */
      --text: rgba(255,255,255,0.92);
      --ring: rgba(255,255,255,0.10);

      --bubble: 56px;
      --gap: 14px;

      --frame-radius: 26px;
      --inner-radius: 20px;

      --shadow-strong: rgba(0,0,0,0.62);
      --shadow-soft: rgba(0,0,0,0.34);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding: 18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);

      /* UPDATED background */
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(255,255,255,0.16), transparent 60%),
        radial-gradient(900px 600px at 82% 90%, rgba(0,0,0,0.10), transparent 55%),
        linear-gradient(180deg, color-mix(in srgb, var(--bg) 86%, white 14%), var(--bg));
    }

    .wrap{
      width: min(980px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
    }

    /* Pop-it frame */
    .popitFrame{
      width: min(940px, 100%);
      border-radius: var(--frame-radius);
      padding: 18px;
      position:relative;
      box-shadow:
        0 26px 70px var(--shadow-strong),
        inset 0 2px 0 rgba(255,255,255,0.12),
        inset 0 -12px 22px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);

      /* Neutral base; colored caps/strips provide the rainbow fill */
      background:
        radial-gradient(140px 90px at 20% 12%, rgba(255,255,255,0.18), transparent 65%),
        radial-gradient(160px 110px at 85% 30%, rgba(255,255,255,0.10), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.12));

      overflow:hidden;
    }

    /* NEW: top/bottom “cap” fills so the rounded edges are colored */
    .cap{
      position:absolute;
      left:0;
      right:0;
      z-index: 0;
      opacity: 0.97;
      filter: saturate(1.06);
      pointer-events:none;
    }
    .cap.top{
      top:0;
      height: 64px; /* enough to color the top lip */
      background: linear-gradient(180deg,
        color-mix(in srgb, #ff3b30 90%, white 10%),
        color-mix(in srgb, #ff3b30 90%, black 10%));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.22), inset 0 -12px 18px rgba(0,0,0,0.18);
    }
    .cap.bottom{
      bottom:0;
      height: 64px; /* enough to color the bottom lip */
      background: linear-gradient(180deg,
        color-mix(in srgb, #af52de 92%, white 8%),
        color-mix(in srgb, #af52de 92%, black 8%));
      box-shadow: inset 0 12px 18px rgba(0,0,0,0.14), inset 0 -1px 0 rgba(255,255,255,0.18);
    }

    /* Inner cavity */
    .board{
      --cols: 10;
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--bubble));
      gap: var(--gap);
      justify-content:center;
      border-radius: var(--inner-radius);
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
      box-shadow:
        inset 0 10px 18px rgba(0,0,0,0.28),
        inset 0 1px 0 rgba(255,255,255,0.14);
      touch-action: manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      z-index: 2;
    }

    /* Row strips (silicone color bands) */
    .rowStrip{
      position:absolute;
      left:0;
      right:0;
      height: calc(var(--bubble) + var(--gap));
      z-index: 0;
      opacity: 0.96;
      filter: saturate(1.06);
      pointer-events:none;
    }

    /* Raised separators between rows */
    .separator{
      position:absolute;
      left: 12px;
      right: 12px;
      height: 10px;
      border-radius: 999px;
      z-index: 1;
      background: linear-gradient(180deg, rgba(255,255,255,0.20), rgba(0,0,0,0.18));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.18),
        0 5px 10px rgba(0,0,0,0.28);
      opacity: 0.9;
      pointer-events:none;
    }

    /* Bubble styling */
    .bubble{
      width: var(--bubble);
      height: var(--bubble);
      border-radius: 999px;
      position:relative;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,0.10);
      outline:none;

      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.55), rgba(255,255,255,0.0) 46%),
        radial-gradient(circle at 55% 62%, rgba(0,0,0,0.25), rgba(0,0,0,0.0) 58%),
        radial-gradient(circle at 50% 50%, color-mix(in srgb, var(--rowColor) 92%, white 8%), var(--rowColor));

      box-shadow:
        0 10px 18px var(--shadow-soft),
        inset 0 1px 0 rgba(255,255,255,0.22);
      transition: transform 140ms cubic-bezier(.2,.8,.2,1), box-shadow 160ms ease, filter 160ms ease;
      display:block;
    }

    .bubble::before{
      content:"";
      position:absolute;
      inset: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.20);
      opacity: 0.9;
      pointer-events:none;
    }

    .bubble[data-state="out"]{
      transform: translateY(0px);
      filter: brightness(1.02);
    }

    .bubble[data-state="in"]{
      transform: translateY(3px) scale(0.985);
      filter: brightness(0.97) saturate(0.98);
      box-shadow:
        0 6px 10px rgba(0,0,0,0.45),
        inset 0 10px 14px rgba(0,0,0,0.30),
        inset 0 -1px 0 rgba(255,255,255,0.10);
      background:
        radial-gradient(circle at 70% 70%, rgba(255,255,255,0.16), rgba(255,255,255,0.0) 55%),
        radial-gradient(circle at 42% 38%, rgba(0,0,0,0.34), rgba(0,0,0,0.0) 58%),
        radial-gradient(circle at 50% 50%, color-mix(in srgb, var(--rowColor) 84%, black 16%), var(--rowColor));
    }

    .bubble:active{
      transform: translateY(4px) scale(0.975);
    }

    /* Controls below */
    .controls{
      width: min(940px, 100%);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      padding: 6px 0 0;
    }

    button{
      appearance:none;
      border: 1px solid var(--ring);
      background: rgba(255,255,255,0.5);
      color: rgba(0,0,0,0.75);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
    }
    button:hover{ background: rgba(255,255,255,0.22); }
    button:active{ transform: translateY(1px) scale(0.99); }

    .iconBtn{
      width: 44px;
      height: 44px;
      padding: 0;
      display:grid;
      place-items:center;
      border-radius: 14px;
    }
    .icon{
      width: 20px;
      height: 20px;
      display:block;
      opacity: 0.9;
    }

    .stat{
      font-size: 12px;
      opacity: 0.92;
      padding-top: 2px;
      text-align:center;
      color: rgba(0,0,0,0.70);
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 999px;
      padding: 6px 12px;
      backdrop-filter: blur(6px);
    }

    @media (max-width: 520px){
      :root{ --bubble: 48px; --gap: 12px; }
      .iconBtn{ width: 42px; height: 42px; }
      button{ font-size: 12px; padding: 10px 12px; }
      .cap.top, .cap.bottom{ height: 56px; }
    }
    @media (max-width: 420px){
      :root{ --bubble: 44px; --gap: 10px; }
      .cap.top, .cap.bottom{ height: 52px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="frame" class="popitFrame" aria-label="Pop it fidget board">
      <!-- NEW caps so top/bottom edges are colored -->
      <div class="cap top"></div>
      <div class="cap bottom"></div>

      <div id="board" class="board"></div>
    </div>

    <div class="controls">
      <button id="resetBtn">Reset</button>
      <button id="shuffleBtn">Shuffle</button>

      <button id="soundBtn" class="iconBtn" aria-label="Toggle sound" title="Sound off">
        <svg id="soundIcon" class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M11 5L6.5 9H3v6h3.5L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M22 9l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M16 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div id="stat" class="stat"></div>
  </div>

  <script>
    // ---------- Config ----------
    const DEFAULT_ROWS = 6;
    const MIN_COLS = 6;
    const MAX_COLS = 12;

    const ROW_COLORS = [
      "#ff3b30", // red
      "#ff9f0a", // orange
      "#ffd60a", // yellow
      "#34c759", // green
      "#32ade6", // cyan/blue
      "#af52de"  // purple
    ];

    // ---------- Elements ----------
    const frame = document.getElementById("frame");
    const board = document.getElementById("board");
    const stat = document.getElementById("stat");
    const resetBtn = document.getElementById("resetBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    // ---------- State ----------
    let rows = DEFAULT_ROWS;
    let cols = 10;

    let soundEnabled = false;
    let audioCtx = null;

    // ---------- Helpers ----------
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function getCSSNumber(varName){
      return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(varName));
    }

    function computeCols(){
      const bubble = getCSSNumber("--bubble");
      const gap = getCSSNumber("--gap");
      const maxWidth = Math.min(980, document.body.clientWidth - 36);
      const usable = maxWidth - 32 - 36;
      const possible = Math.floor((usable + gap) / (bubble + gap));
      cols = clamp(possible, MIN_COLS, MAX_COLS);
      board.style.setProperty("--cols", cols);
    }

    function updateStat(){
      const bubbles = board.querySelectorAll(".bubble");
      let inCount = 0;
      for (const b of bubbles) if (b.dataset.state === "in") inCount++;
      stat.textContent = `${inCount} / ${bubbles.length} popped`;
    }

    // ---------- Sound (mobile-safe) ----------
    async function ensureAudio(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === "suspended"){
        await audioCtx.resume();
      }
    }

    function popSound(){
      if (!soundEnabled) return;
      if (!audioCtx || audioCtx.state !== "running") return;

      const t = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(220, t);
      osc.frequency.exponentialRampToValueAtTime(110, t + 0.05);

      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.22, t + 0.006);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.07);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t + 0.075);

      const bufferSize = Math.floor(audioCtx.sampleRate * 0.03);
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++){
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize / 6));
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;

      const nGain = audioCtx.createGain();
      nGain.gain.setValueAtTime(0.12, t);
      nGain.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);

      noise.connect(nGain).connect(audioCtx.destination);
      noise.start(t);
      noise.stop(t + 0.031);
    }

    function setSoundUI(){
      soundBtn.title = soundEnabled ? "Sound on" : "Sound off";
      soundIcon.innerHTML = soundEnabled
        ? `
          <path d="M11 5L6.5 9H3v6h3.5L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M15.5 8.5c1.2 1.2 1.2 5.8 0 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M18.5 6c2.7 2.7 2.7 9.3 0 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        `
        : `
          <path d="M11 5L6.5 9H3v6h3.5L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M22 9l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M16 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        `;
    }

    // ---------- Pop-it visuals (row strips + separators) ----------
    function buildRowStrips(){
      [...frame.querySelectorAll(".rowStrip, .separator")].forEach(n => n.remove());

      const bubble = getCSSNumber("--bubble");
      const gap = getCSSNumber("--gap");
      const framePadTop = 18;
      const boardPadTop = 14;
      const cellH = bubble + gap;

      for (let r = 0; r < rows; r++){
        const strip = document.createElement("div");
        strip.className = "rowStrip";
        strip.style.top = `${framePadTop + boardPadTop + r * cellH}px`;

        const c = ROW_COLORS[r % ROW_COLORS.length];
        strip.style.background =
          `linear-gradient(180deg,
            color-mix(in srgb, ${c} 92%, white 8%),
            color-mix(in srgb, ${c} 92%, black 8%))`;

        strip.style.boxShadow =
          "inset 0 1px 0 rgba(255,255,255,0.22), inset 0 -10px 18px rgba(0,0,0,0.20)";

        frame.insertBefore(strip, board);
      }

      for (let r = 1; r < rows; r++){
        const sep = document.createElement("div");
        sep.className = "separator";
        sep.style.top = `${framePadTop + boardPadTop + r * cellH - (gap/2) - 5}px`;
        frame.insertBefore(sep, board);
      }
    }

    // ---------- Bubble actions ----------
    function toggleBubble(el){
      el.dataset.state = (el.dataset.state === "out") ? "in" : "out";
      if (navigator.vibrate) navigator.vibrate(8);
      popSound();
      updateStat();
    }

    function setAll(state){
      board.querySelectorAll(".bubble").forEach(b => b.dataset.state = state);
      updateStat();
    }

    function shuffle(){
      board.querySelectorAll(".bubble").forEach(b => {
        b.dataset.state = (Math.random() < 0.5) ? "out" : "in";
      });
      updateStat();
    }

    // ---------- Build board ----------
    function buildBoard(){
      board.innerHTML = "";

      for (let r = 0; r < rows; r++){
        const rowColor = ROW_COLORS[r % ROW_COLORS.length];

        for (let c = 0; c < cols; c++){
          const b = document.createElement("div");
          b.className = "bubble";
          b.tabIndex = 0;
          b.role = "button";
          b.ariaLabel = "Pop bubble";
          b.dataset.state = "out";
          b.style.setProperty("--rowColor", rowColor);

          b.addEventListener("click", async () => {
            if (soundEnabled) { try { await ensureAudio(); } catch(_) {} }
            toggleBubble(b);
          });

          b.addEventListener("keydown", async (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              if (soundEnabled) { try { await ensureAudio(); } catch(_) {} }
              toggleBubble(b);
            }
          });

          board.appendChild(b);
        }
      }

      updateStat();
      buildRowStrips();
    }

    // ---------- Controls ----------
    resetBtn.addEventListener("click", async () => {
      if (soundEnabled) { try { await ensureAudio(); } catch(_) {} }
      setAll("out");
    });

    shuffleBtn.addEventListener("click", async () => {
      if (soundEnabled) { try { await ensureAudio(); } catch(_) {} }
      shuffle();
    });

    soundBtn.addEventListener("click", async () => {
      soundEnabled = !soundEnabled;
      setSoundUI();

      if (soundEnabled) {
        try {
          await ensureAudio();
          popSound();
        } catch(e) {
          soundEnabled = false;
          setSoundUI();
        }
      }
    });

    // ---------- Resize ----------
    let resizeTimer = null;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        computeCols();
        buildBoard();
      }, 120);
    });

    // Init
    setSoundUI();
    computeCols();
    buildBoard();
  </script>
</body>
</html>
